Description: Use cups-filter's filters, type declarations, conversions
 and libraries. This fixes the tests that need those.
Origin: vendor
Author: Didier Raboud <odyx@debian.org>
Last-Update: 2012-10-14
--- a/test/run-stp-tests.sh
+++ b/test/run-stp-tests.sh
@@ -323,12 +323,6 @@
 ln -s $root/filter/rastertolabel /tmp/cups-$user/bin/filter
 ln -s $root/filter/rastertopwg /tmp/cups-$user/bin/filter
 
-ln -s $root/data/classified /tmp/cups-$user/share/banners
-ln -s $root/data/confidential /tmp/cups-$user/share/banners
-ln -s $root/data/secret /tmp/cups-$user/share/banners
-ln -s $root/data/standard /tmp/cups-$user/share/banners
-ln -s $root/data/topsecret /tmp/cups-$user/share/banners
-ln -s $root/data/unclassified /tmp/cups-$user/share/banners
 ln -s $root/data /tmp/cups-$user/share
 ln -s $root/ppdc/sample.drv /tmp/cups-$user/share/drv
 ln -s $root/conf/mime.types /tmp/cups-$user/share/mime
@@ -361,7 +355,6 @@
 		ln -s /usr/share/cups/mime/apple.* /tmp/cups-$user/share/mime
 	fi
 else
-	ln -s /usr/lib/cups/filter/bannertops /tmp/cups-$user/bin/filter
 	ln -s /usr/lib/cups/filter/imagetops /tmp/cups-$user/bin/filter
 	ln -s /usr/lib/cups/filter/imagetoraster /tmp/cups-$user/bin/filter
 	ln -s /usr/lib/cups/filter/pdftops /tmp/cups-$user/bin/filter
@@ -373,6 +366,37 @@
 		ln -s /usr/share/cups/data/psglyphs $root/data
 	fi
 	ln -s /usr/share/cups/fonts /tmp/cups-$user/share
+
+	#
+	# cups-filters 1.0.38
+	#
+	ln -s /usr/share/cups/mime/cupsfilters.types /tmp/cups-$user/share/mime
+	# Use cups-filter's patched 1.0.38 that doesn't make the test-suite fail
+	ln -s $root/conf/cupsfilters.convs /tmp/cups-$user/share/mime
+
+	ln -s /usr/lib/cups/filter/bannertopdf /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/commandtoescpx /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/commandtopclx /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/gstopxl /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/gstoraster /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/imagetopdf /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/pdftoijs /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/pdftoopvp /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/pdftopdf /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/pdftoraster /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/pstopdf /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/rastertoescpx /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/rastertopclx /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/textonly /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/texttopdf /tmp/cups-$user/bin/filter
+	ln -s /usr/lib/cups/filter/urftopdf /tmp/cups-$user/bin/filter
+
+	ln -s /usr/share/cups/banners/classified /tmp/cups-$user/share/banners
+	ln -s /usr/share/cups/banners/confidential /tmp/cups-$user/share/banners
+	ln -s /usr/share/cups/banners/secret /tmp/cups-$user/share/banners
+	ln -s /usr/share/cups/banners/standard /tmp/cups-$user/share/banners
+	ln -s /usr/share/cups/banners/topsecret /tmp/cups-$user/share/banners
+	ln -s /usr/share/cups/banners/unclassified /tmp/cups-$user/share/banners
 fi
 
 #
@@ -491,6 +515,8 @@
 if test `uname` = SunOS -a -r /usr/lib/libCrun.so.1; then
 	LD_PRELOAD="/usr/lib/libCrun.so.1:$LD_PRELOAD"
 fi
+# Add cups-filters'
+LD_PRELOAD="/usr/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)/libcupsfilters.so.1:$LD_PRELOAD"
 export LD_PRELOAD
 
 if test "x$DYLD_LIBRARY_PATH" = x; then
--- /dev/null
+++ b/conf/cupsfilters.convs
@@ -0,0 +1,128 @@
+#
+# "$Id: $"
+#
+#   MIME conversions file for OpenPrinting CUPS Filters.
+#
+#   Copyright 2007-2011 by Apple Inc.
+#   Copyright 1997-2007 by Easy Software Products.
+#
+#   These coded instructions, statements, and computer programs are the
+#   property of Apple Inc. and are protected by Federal copyright
+#   law.  Distribution and use rights are outlined in the file "LICENSE.txt"
+#   which should have been included with this file.  If this file is
+#   file is missing or damaged, see the license at "http://www.cups.org/".
+#
+
+########################################################################
+#
+# Format of Lines:
+#
+#   source/type destination/type cost filter
+#
+# General Notes:
+#
+#   The "cost" field is used to find the least costly filters to run
+#   when converting a job file to a printable format.
+#
+#   All filters *must* accept the standard command-line arguments
+#   (job-id, user, title, copies, options, [filename or stdin]) to
+#   work with CUPS.
+#
+
+########################################################################
+#
+# PDF filters
+#
+
+# CUPS file conversion rules for PostScript input when we are working with
+# the PDF printing workflow. General PostScript input should be converted to
+# PDF, so that pdftopdf is doing the page management on PDF data and the
+# renderer/driver part renders PDF. An exception is made for PostScript
+# coming from the Adobe Reader. As this PostScript cannot be converted to PDF
+# if it comes from an encrypted PDF file, we simply override pstopdf and the
+# PDF workflow.
+
+application/postscript	application/pdf				0	pstopdf
+application/vnd.adobe-reader-postscript	application/vnd.cups-postscript	66	pstops
+
+# Original:
+# application/pdf		application/vnd.cups-pdf		66	pdftopdf
+# Patched:
+application/pdf		application/vnd.cups-pdf		22	pdftopdf
+
+application/x-cshell	application/pdf				32	texttopdf
+application/x-csource	application/pdf				32	texttopdf
+application/x-perl	application/pdf				32	texttopdf
+application/x-shell	application/pdf				32	texttopdf
+text/plain		application/pdf				32	texttopdf
+text/html		application/pdf				32	texttopdf
+image/gif		application/vnd.cups-pdf		65	imagetopdf
+image/png		application/vnd.cups-pdf		65	imagetopdf
+image/jpeg		application/vnd.cups-pdf		65	imagetopdf
+image/tiff		application/vnd.cups-pdf		65	imagetopdf
+image/x-bitmap		application/vnd.cups-pdf		65	imagetopdf
+image/x-photocd		application/vnd.cups-pdf		65	imagetopdf
+image/x-portable-anymap	application/vnd.cups-pdf		65	imagetopdf
+image/x-portable-bitmap	application/vnd.cups-pdf		65	imagetopdf
+image/x-portable-graymap application/vnd.cups-pdf		65	imagetopdf
+image/x-portable-pixmap	application/vnd.cups-pdf		65	imagetopdf
+image/x-sgi-rgb		application/vnd.cups-pdf		65	imagetopdf
+image/x-xbitmap		application/vnd.cups-pdf		65	imagetopdf
+image/x-xpixmap		application/vnd.cups-pdf		65	imagetopdf
+image/x-xwindowdump	application/vnd.cups-pdf		65	imagetopdf
+image/x-sun-raster	application/vnd.cups-pdf		65	imagetopdf
+application/vnd.cups-pdf-banner	application/pdf			32	bannertopdf
+image/urf		application/pdf				0	urftopdf
+
+########################################################################
+#
+# PostScript filters
+#
+
+#application/pdf		application/vnd.cups-postscript	66	pdftops
+
+# Original:
+# application/vnd.cups-pdf	application/vnd.cups-postscript	100	pdftops
+# Patched:
+application/vnd.cups-pdf	application/vnd.cups-postscript	22	pdftops
+
+#application/postscript		application/vnd.cups-postscript	66	pstops
+
+########################################################################
+#
+# Raster filters...
+#
+
+application/vnd.cups-pdf	application/vnd.cups-raster	99	gstoraster
+application/vnd.cups-postscript	application/vnd.cups-raster	200	gstoraster
+application/vnd.cups-pdf	application/vnd.cups-raster	100	pdftoraster
+image/gif			application/vnd.cups-raster	100	imagetoraster
+image/png			application/vnd.cups-raster	100	imagetoraster
+image/jpeg			application/vnd.cups-raster	100	imagetoraster
+image/tiff			application/vnd.cups-raster	100	imagetoraster
+image/x-bitmap			application/vnd.cups-raster	100	imagetoraster
+image/x-photocd			application/vnd.cups-raster	100	imagetoraster
+image/x-portable-anymap		application/vnd.cups-raster	100	imagetoraster
+image/x-portable-bitmap		application/vnd.cups-raster	100	imagetoraster
+image/x-portable-graymap	application/vnd.cups-raster	100	imagetoraster
+image/x-portable-pixmap		application/vnd.cups-raster	100	imagetoraster
+image/x-sgi-rgb			application/vnd.cups-raster	100	imagetoraster
+image/x-xbitmap			application/vnd.cups-raster	100	imagetoraster
+image/x-xpixmap			application/vnd.cups-raster	100	imagetoraster
+image/x-sun-raster		application/vnd.cups-raster	100	imagetoraster
+
+########################################################################
+#
+# Text filters (only for text-only printers)...
+#
+
+application/x-cshell		text/plain			100	-
+application/x-csource		text/plain			100	-
+application/x-perl		text/plain			100	-
+application/x-shell		text/plain			100	-
+text/html			text/plain			100	-
+text/css			text/plain			100	-
+
+#
+# End of "$Id: $".
+#
